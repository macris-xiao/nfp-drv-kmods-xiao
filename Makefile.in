KERNELDIR=@KERNELDIR@
KERNEL_ARCH=@KERNEL_ARCH@
KERNEL_CROSS_COMPILE=@KERNEL_CROSS_COMPILE@
srcdir=@srcdir@
abs_srcdir=@abs_srcdir@
abs_builddir=@abs_builddir@
kmod_files=@kmod_files@
nfp_src_ver=@nfp_src_ver@

ifdef INSTALL_MOD_DIR
__INSTALL_MOD_DIR = INSTALL_MOD_DIR=$(INSTALL_MOD_DIR)
endif

all: modules
install: modules_install
modules_install: modules

modules modules_install clean: $(kmod_files)
ifeq ($(KERNELDIR),)
	@echo KERNELDIR is not set --- skipping driver build
else
	$(MAKE) -C $(KERNELDIR) M=$(abs_builddir) \
		INSTALL_MOD_PATH=$(or $(DESTDIR),$(INSTALL_MOD_PATH)) \
		$(__INSTALL_MOD_DIR) \
		EXTRA_CFLAGS=$(EXTRA_CFLAGS) \
		ARCH=$(KERNEL_ARCH) \
		CROSS_COMPILE=$(KERNEL_CROSS_COMPILE) \
		makecmd=$@ \
		nfp_src_ver=$(nfp_src_ver) $@
endif

distdir:
distclean:

$(kmod_files):
	test -d $(@D) || mkdir -p $(@D)
	ln -sf $(abs_srcdir)/$@ $@
